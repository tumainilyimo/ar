<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Important for mobile scaling -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

  <title>AR GPS Navigation with Fixes</title>

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- A-Frame and AR.js -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    /* Basic styling and layout */

    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      /* Touch handling to avoid accidental scrolling when interacting with map/AR */
      touch-action: none;
    }

    /* Map container */
    #map {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      z-index: 1;
    }

    /* UI overlay (status bar, buttons, etc.) */
    #ui-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      /* We also place buttons in here with pointer-events: auto; */
    }

    /* Status bar at the top */
    #status-bar {
      margin-top: 20px;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 8px 16px;
      border-radius: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      pointer-events: auto;
    }

    /* Distance display near bottom */
    #distance-display {
      margin-bottom: 80px;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 8px 16px;
      border-radius: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      pointer-events: auto;
      display: none;
    }

    /* Buttons (e.g., Start AR, Back, Retry) */
    .button {
      pointer-events: auto;
      padding: 12px 24px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .button:active {
      transform: translateY(1px);
    }

    #start-ar {
      display: none; /* Will appear after setting a destination */
    }

    #back-button {
      display: none; /* Visible only in AR mode */
    }

    #retry-button {
      display: none; /* Visible if geolocation fails */
    }

    /* Loading overlay with spinner */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* AR Scene hidden by default */
    a-scene {
      display: none; /* We'll show it when "Start AR" is clicked */
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 3; /* On top of everything when active */
    }
  </style>
</head>

<body>
  <!-- Map container -->
  <div id="map"></div>

  <!-- Loading overlay (shown at start or while re-initializing) -->
  <div id="loading-overlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- UI Overlay -->
  <div id="ui-overlay">
    <!-- Status message area -->
    <div id="status-bar">Initializing...</div>
    
    <!-- Distance display (hidden until in AR mode) -->
    <div id="distance-display"></div>

    <!-- Buttons (bottom area) -->
    <div style="margin-bottom: 30px;">
      <button id="start-ar" class="button">Start AR Navigation</button>
      <button id="back-button" class="button">Back to Map</button>
      <button id="retry-button" class="button">Retry GPS</button>
    </div>
  </div>

  <!-- AR Scene -->
  <a-scene
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;"
    vr-mode-ui="enabled: false">

    <!-- GPS camera (from AR.js) -->
    <a-camera gps-camera rotation-reader look-controls-enabled="false" arjs-look-at-disabled></a-camera>

    <!-- Destination marker in AR -->
    <a-entity id="destination-marker"></a-entity>
  </a-scene>

  <script>
    // ------------------------------------------------------------
    // Global Variables
    // ------------------------------------------------------------
    let map, userMarker, destinationMarker;
    let watchId = null;             // ID from geolocation watch
    let currentPosition = null;     // Holds the latest user position
    let arMode = false;            // Track if we are in AR mode

    // ------------------------------------------------------------
    // Utility / Helper Functions
    // ------------------------------------------------------------
    function showElement(id) {
      document.getElementById(id).style.display = 'block';
    }
    function hideElement(id) {
      document.getElementById(id).style.display = 'none';
    }
    function setStatus(message) {
      document.getElementById('status-bar').textContent = message;
    }

    // Calculate distance between two lat/long pairs in meters
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // Earth's radius in meters
      const φ1 = lat1 * Math.PI / 180;
      const φ2 = lat2 * Math.PI / 180;
      const Δφ = (lat2 - lat1) * Math.PI / 180;
      const Δλ = (lon2 - lon1) * Math.PI / 180;

      const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

      return R * c; // Distance in meters
    }

    // ------------------------------------------------------------
    // Initialization
    // ------------------------------------------------------------
    async function initializeApp() {
      try {
        showElement('loading-overlay');
        setStatus('Checking location permissions...');

        // (Optional) Check geolocation permission if supported
        if (navigator.permissions) {
          const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });
          if (permissionStatus.state === 'denied') {
            hideElement('loading-overlay');
            setStatus('Location permission denied. Please enable it in your browser/device settings.');
            showElement('retry-button');
            return;
          }
        }

        setStatus('Fetching your current location...');
        
        // Attempt to get current position with increased timeout
        const position = await getCurrentPosition();
        hideElement('loading-overlay');

        // Initialize map with that position
        initializeMap(position);
        
        // Start watching for position updates
        startLocationTracking();

        setStatus('Tap on the map to set your destination');
      } catch (error) {
        handleLocationError(error);
      }
    }

    // Get current position (returns a Promise)
    function getCurrentPosition() {
      return new Promise((resolve, reject) => {
        const options = {
          enableHighAccuracy: true,
          timeout: 30000,  // 30-second timeout
          maximumAge: 0
        };

        navigator.geolocation.getCurrentPosition(resolve, reject, options);
      });
    }

    // Initialize Leaflet map
    function initializeMap(position) {
      const { latitude, longitude } = position.coords;

      // Create the map centered on the user's location
      map = L.map('map').setView([latitude, longitude], 18);

      // Add OSM tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      // User marker
      userMarker = L.marker([latitude, longitude], {
        icon: L.divIcon({
          html: '📍',
          className: 'user-location-marker',
          iconSize: [25, 25]
        })
      }).addTo(map);

      // Handle clicks on the map to set destination
      map.on('click', handleMapClick);
    }

    // Start continuous location tracking (watch)
    function startLocationTracking() {
      const options = {
        enableHighAccuracy: true,
        timeout: 60000,  // 1-minute timeout
        maximumAge: 0
      };

      watchId = navigator.geolocation.watchPosition(
        updatePosition,     // success
        handleLocationError, // error
        options
      );
    }

    // Called repeatedly by watchPosition when location changes
    function updatePosition(position) {
      currentPosition = position;
      const { latitude, longitude } = position.coords;

      // Update user marker on the map
      if (userMarker) {
        userMarker.setLatLng([latitude, longitude]);
      }

      // If in AR mode and we have a destination, update AR elements
      if (arMode && destinationMarker) {
        updateARElements(position);
      }
    }

    // ------------------------------------------------------------
    // Map Click -> Set Destination
    // ------------------------------------------------------------
    function handleMapClick(e) {
      // Remove old destination if any
      if (destinationMarker) {
        map.removeLayer(destinationMarker);
      }

      // Create a new Leaflet marker for the destination
      destinationMarker = L.marker(e.latlng).addTo(map);

      showElement('start-ar');
      setStatus('Destination set! Tap "Start AR Navigation" to begin');
    }

    // ------------------------------------------------------------
    // AR Initialization
    // ------------------------------------------------------------
    function initializeAR() {
      // We must have a current user position and destination set
      if (!currentPosition || !destinationMarker) {
        setStatus('Cannot start AR: no user position or destination!');
        return;
      }

      // Show AR scene, hide map
      const scene = document.querySelector('a-scene');
      scene.style.display = 'block';
      hideElement('map');

      // Grab destination coordinates from Leaflet marker
      const destEntity = document.getElementById('destination-marker');
      const destPos = destinationMarker.getLatLng();

      // Attach AR.js gps-entity-place
      destEntity.setAttribute('gps-entity-place', `latitude: ${destPos.lat}; longitude: ${destPos.lng}`);

      // Add a 3D shape or model to represent the destination
      const box = document.createElement('a-box');
      box.setAttribute('color', 'red');
      box.setAttribute('scale', '20 20 20'); // Adjust size as needed
      destEntity.appendChild(box);

      // Add text label that always faces the camera
      const text = document.createElement('a-text');
      text.setAttribute('value', 'DESTINATION');
      text.setAttribute('look-at', '[gps-camera]');
      text.setAttribute('scale', '100 100 100');
      text.setAttribute('position', '0 40 0'); // offset above the box
      destEntity.appendChild(text);

      arMode = true;
    }

    // Called every time we get a new user position in AR mode
    function updateARElements(position) {
      if (!destinationMarker) return;

      const destPos = destinationMarker.getLatLng();
      const distance = calculateDistance(
        position.coords.latitude,
        position.coords.longitude,
        destPos.lat,
        destPos.lng
      );

      const distanceDisplay = document.getElementById('distance-display');
      distanceDisplay.textContent = `Distance to destination: ${distance.toFixed(0)} m`;
    }

    // ------------------------------------------------------------
    // Error Handling
    // ------------------------------------------------------------
    function handleLocationError(error) {
      // Hide loading overlay, show retry
      hideElement('loading-overlay');
      showElement('retry-button');

      let message = 'Location error: ';
      switch (error.code) {
        case error.PERMISSION_DENIED:
          message += 'Permission denied. Please allow location access in your browser/device settings.';
          break;
        case error.POSITION_UNAVAILABLE:
          message += 'Position unavailable. Move to an area with better GPS signal (e.g., outdoors).';
          break;
        case error.TIMEOUT:
          message += 'Request timed out. Try increasing the timeout or moving to a better signal area.';
          break;
        default:
          message += error.message;
      }
      setStatus(message);
    }

    // ------------------------------------------------------------
    // Button Event Listeners
    // ------------------------------------------------------------
    document.getElementById('start-ar').addEventListener('click', () => {
      if (!destinationMarker) {
        setStatus('Please tap on the map to set a destination first.');
        return;
      }
      hideElement('start-ar');
      showElement('back-button');
      showElement('distance-display');
      initializeAR();
    });

    document.getElementById('back-button').addEventListener('click', () => {
      // Return to map view
      const scene = document.querySelector('a-scene');
      scene.style.display = 'none';  // Hide AR
      showElement('map');
      showElement('start-ar');       // Let user re-enter AR if they want
      hideElement('back-button');
      hideElement('distance-display');
      arMode = false;
    });

    document.getElementById('retry-button').addEventListener('click', () => {
      hideElement('retry-button');
      initializeApp();
    });

    // ------------------------------------------------------------
    // Start the application once page loads
    // ------------------------------------------------------------
    window.addEventListener('load', () => {
      initializeApp();
    });
  </script>
</body>
</html>
