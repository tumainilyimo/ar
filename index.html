<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR GPS Navigation</title>

    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- A-Frame and AR.js -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            touch-action: none;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }

        #ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .button {
            pointer-events: auto;
            padding: 12px 24px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            margin-bottom: 10px;
        }

        .button:active {
            transform: translateY(1px);
        }

        #status-bar {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            z-index: 1000;
            pointer-events: auto;
            margin-bottom: 10px;
        }

        #start-ar, #start-manual-ar {
            display: none;
        }

        #back-button {
            display: none;
            z-index: 1000;
        }

        #retry-button {
            display: none;
        }

        #distance-display {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 20px;
            display: none;
            z-index: 1000;
            margin-top: 10px;
        }

        .ar-only {
            display: none;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }

        .input-group label {
            margin-bottom: 5px;
            color: #333;
        }

        .input-group input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- Map container -->
    <div id="map"></div>

    <!-- Loading overlay -->
    <div id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- UI Elements -->
    <div id="ui-overlay">
        <div id="status-bar">Initializing GPS...</div>
        <button id="start-ar" class="button">Start AR Navigation to Clicked Point</button>

        <div class="input-group">
            <label for="dest1-lat">Destination 1 Latitude:</label>
            <input type="number" id="dest1-lat" placeholder="Latitude">
        </div>
        <div class="input-group">
            <label for="dest1-lng">Destination 1 Longitude:</label>
            <input type="number" id="dest1-lng" placeholder="Longitude">
        </div>

        <div class="input-group">
            <label for="dest2-lat">Destination 2 Latitude:</label>
            <input type="number" id="dest2-lat" placeholder="Latitude">
        </div>
        <div class="input-group">
            <label for="dest2-lng">Destination 2 Longitude:</label>
            <input type="number" id="dest2-lng" placeholder="Longitude">
        </div>

        <button id="start-manual-ar" class="button">Start AR Navigation to Manual Points</button>
        <button id="back-button" class="button">Back to Map</button>
        <button id="retry-button" class="button">Retry GPS</button>
        <div id="distance-display"></div>
    </div>

    <!-- AR Scene -->
    <a-scene
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;"
        vr-mode-ui="enabled: false"
        style="display: none;">

        <a-camera gps-camera rotation-reader look-controls-enabled="false" arjs-look-at-disabled></a-camera>
        <a-entity id="ar-pointer"></a-entity>
        <a-entity id="destination-marker"></a-entity>
    </a-scene>

    <script>
        // Global variables
        let map, userMarker;
        let watchId = null;
        let currentPosition = null;
        let arMode = false;
        let destinationMarker = null; // For map click destination
        let manualDestinations = [];
        let currentManualDestinationIndex = 0;
        const ARRIVAL_THRESHOLD = 20; // meters

        // Utility functions
        function showElement(id) {
            document.getElementById(id).style.display = 'block';
        }

        function hideElement(id) {
            document.getElementById(id).style.display = 'none';
        }

        function setStatus(message) {
            document.getElementById('status-bar').textContent = message;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                    Math.cos(Ï†1) * Math.cos(Ï†2) *
                    Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distance in meters
        }

        // Initialize application
        async function initializeApp() {
            try {
                showElement('loading-overlay');
                setStatus('Checking location permissions...');

                if (navigator.permissions) {
                    const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });
                    if (permissionStatus.state === 'denied') {
                        hideElement('loading-overlay');
                        setStatus('Location permission denied. Please enable it in your browser settings.');
                        showElement('retry-button');
                        return;
                    }
                }

                setStatus('Fetching your location...');
                const position = await getCurrentPosition();
                hideElement('loading-overlay');

                initializeMap(position);
                startLocationTracking();

                setStatus('Click on the map to set a single destination, or enter two destinations below.');
                showElement('start-manual-ar');
            } catch (error) {
                handleLocationError(error);
            }
        }

        // Get current position with promise
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000, // Reduced timeout for quicker feedback
                    maximumAge: 0
                };

                navigator.geolocation.getCurrentPosition(resolve, reject, options);
            });
        }

        // Initialize map
        function initializeMap(position) {
            const { latitude, longitude } = position.coords;

            map = L.map('map').setView([latitude, longitude], 18);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // Add user marker
            userMarker = L.marker([latitude, longitude], {
                icon: L.divIcon({
                    html: 'ðŸ“',
                    className: 'user-location-marker',
                    iconSize: [25, 25]
                })
            }).addTo(map);

            // Handle map clicks
            map.on('click', handleMapClick);
            showElement('start-ar'); // Show button for map click destination
        }

        // Start tracking location
        function startLocationTracking() {
            const options = {
                enableHighAccuracy: true,
                timeout: 30000,
                maximumAge: 0
            };

            watchId = navigator.geolocation.watchPosition(
                updatePosition,
                handleLocationError,
                options
            );
        }

        // Update position
        function updatePosition(position) {
            currentPosition = position;
            const { latitude, longitude } = position.coords;

            if (userMarker) {
                userMarker.setLatLng([latitude, longitude]);
            }

            if (arMode) {
                updateARElements(position);
            }
        }

        // Handle map clicks
        function handleMapClick(e) {
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
            }
            destinationMarker = L.marker(e.latlng).addTo(map);
            showElement('start-ar');
            setStatus('Destination set! Click "Start AR Navigation to Clicked Point" to begin.');
        }

        // Initialize AR with manual destinations
        function initializeARWithManualDestinations() {
            const dest1Lat = parseFloat(document.getElementById('dest1-lat').value);
            const dest1Lng = parseFloat(document.getElementById('dest1-lng').value);
            const dest2Lat = parseFloat(document.getElementById('dest2-lat').value);
            const dest2Lng = parseFloat(document.getElementById('dest2-lng').value);

            if (isNaN(dest1Lat) || isNaN(dest1Lng) || isNaN(dest2Lat) || isNaN(dest2Lng)) {
                setStatus('Please enter valid latitude and longitude for both destinations.');
                return;
            }

            manualDestinations = [
                L.latLng(dest1Lat, dest1Lng),
                L.latLng(dest2Lat, dest2Lng)
            ];
            currentManualDestinationIndex = 0;
            startARNavigation();
        }

        // Initialize AR
        function initializeAR(destination) {
            if (!currentPosition || !destination) return;

            const scene = document.querySelector('a-scene');
            scene.style.display = 'block';

            const destEntity = document.getElementById('destination-marker');

            // Create destination marker in AR
            destEntity.setAttribute('gps-entity-place', `latitude: ${destination.lat}; longitude: ${destination.lng}`);

            // Add 3D model or primitive shape
            const model = document.createElement('a-box');
            model.setAttribute('color', 'red');
            model.setAttribute('scale', '20 20 20');
            destEntity.appendChild(model);

            // Add text label
            const text = document.createElement('a-text');
            text.setAttribute('id', 'destination-label');
            text.setAttribute('value', 'DESTINATION');
            text.setAttribute('look-at', '[gps-camera]');
            text.setAttribute('scale', '100 100 100');
            text.setAttribute('position', '0 30 0');
            destEntity.appendChild(text);

            arMode = true;
        }

        function startARNavigation() {
            hideElement('map');
            hideElement('start-ar');
            hideElement('start-manual-ar');
            showElement('back-button');
            showElement('distance-display');
            currentManualDestinationIndex = 0;
            updateARDestination();
            arMode = true;
            setStatus(`Navigating to Destination ${currentManualDestinationIndex + 1}`);
        }

        function updateARDestination() {
            if (manualDestinations.length === 0) return;

            const currentTarget = manualDestinations[currentManualDestinationIndex];
            const destEntity = document.getElementById('destination-marker');
            destEntity.setAttribute('gps-entity-place', `latitude: ${currentTarget.lat}; longitude: ${currentTarget.lng}`);
            document.getElementById('destination-label').setAttribute('value', `DESTINATION ${currentManualDestinationIndex + 1}`);
        }

        // Update AR elements (like distance display)
        function updateARElements(position) {
            if (!arMode) return;

            let targetDestination;
            if (manualDestinations.length > 0) {
                targetDestination = manualDestinations[currentManualDestinationIndex];
            } else if (destinationMarker) {
                targetDestination = destinationMarker.getLatLng();
            } else {
                return;
            }

            const distance = calculateDistance(
                position.coords.latitude,
                position.coords.longitude,
                targetDestination.lat,
                targetDestination.lng
            );

            document.getElementById('distance-display').textContent = `Distance to Destination ${currentManualDestinationIndex + 1 || ''}: ${distance.toFixed(0)} meters`;

            if (manualDestinations.length > 0 && distance <= ARRIVAL_THRESHOLD && currentManualDestinationIndex < manualDestinations.length - 1) {
                currentManualDestinationIndex++;
                updateARDestination();
                setStatus(`Arrived at Destination ${currentManualDestinationIndex}. Navigating to Destination ${currentManualDestinationIndex + 1}`);
            } else if (manualDestinations.length > 0 && distance <= ARRIVAL_THRESHOLD && currentManualDestinationIndex === manualDestinations.length - 1) {
                setStatus("Arrived at final destination!");
            }
        }

        // Handle location errors
        function handleLocationError(error) {
            hideElement('loading-overlay');
            showElement('retry-button');

            let message = 'Location error: ';
            switch(error.code) {
                case 1:
                    message += 'Please enable location permissions in your browser settings.';
                    break;
                case 2:
                    message += 'Position unavailable. Ensure your device location is enabled and try again.';
                    break;
                case 3:
                    message += 'Timeout - Location request took too long. Please ensure you have a good GPS signal and try again.';
                    break;
                default:
                    message += error.message;
            }
            setStatus(message);
        }

        // Event Listeners
        document.getElementById('start-ar').addEventListener('click', () => {
            if (!destinationMarker) {
                setStatus('Please set a destination on the map first.');
                return;
            }
            startARNavigationToPoint(destinationMarker.getLatLng());
        });

        document.getElementById('start-manual-ar').addEventListener('click', () => {
            initializeARWithManualDestinations();
        });

        function startARNavigationToPoint(destination) {
            hideElement('map');
            hideElement('start-ar');
            hideElement('start-manual-ar');
            showElement('back-button');
            showElement('distance-display');
            initializeAR(destination);
            arMode = true;
            setStatus('Navigating to destination');
        }

        document.getElementById('back-button').addEventListener('click', () => {
            showElement('map');
            showElement('start-ar');
            showElement('start-manual-ar');
            hideElement('back-button');
            hideElement('distance-display');
            document.querySelector('a-scene').style.display = 'none';
            arMode = false;
            manualDestinations = []; // Clear manual destinations
            setStatus('Click on the map to set a single destination, or enter two destinations below.');
        });

        document.getElementById('retry-button').addEventListener('click', () => {
            hideElement('retry-button');
            initializeApp();
        });

        // Start the application
        initializeApp();
    </script>
</body>
</html>
