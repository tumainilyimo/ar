<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, 
                                 user-scalable=no, 
                                 minimum-scale=1.0, 
                                 maximum-scale=1.0">
  <title>Tanzania AR Navigation</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    #map {
      width: 100%;
      height: 100vh;
      position: absolute;
      z-index: 1;
    }
    .ar-scene {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      display: none;
    }
    #startARButton {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #instructions {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 5px;
      text-align: center;
    }
    #distance {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div id="instructions">Loading your current location...</div>
  <div id="map"></div>
  <div id="distance" style="display: none;"></div>
  <button id="startARButton" style="display: none;">Start AR Navigation</button>

  <a-scene embedded class="ar-scene" vr-mode-ui="enabled: false" arjs="sourceType: webcam; debugUIEnabled: false;">
    <a-camera gps-camera rotation-reader></a-camera>
    <a-entity id="startPoint"></a-entity>
    <a-entity id="endPoint"></a-entity>
    <a-entity id="directionArrow"></a-entity>
  </a-scene>

  <script>
    let startPoint = null;
    let endPoint = null;
    let markers = [];
    let userMarker = null;
    let map;

    // Initialize with geolocation
    navigator.geolocation.getCurrentPosition(
      function(position) {
        const userLat = position.coords.latitude;
        const userLng = position.coords.longitude;
        
        // Initialize map centered on user's location (Tanzania)
        map = L.map('map').setView([userLat, userLng], 15);
        
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Add user's location marker
        userMarker = L.marker([userLat, userLng], {
          icon: L.divIcon({
            className: 'user-marker',
            html: '📍',
            iconSize: [25, 25]
          })
        }).addTo(map);

        // Update instructions
        document.getElementById('instructions').textContent = 
          'Click to set destination point';

        // Set start point as current location
        startPoint = L.latLng(userLat, userLng);
        
        // Update user location periodically
        setInterval(() => updateUserLocation(), 5000);
      },
      function(error) {
        alert('Error getting location: ' + error.message);
      },
      {
        enableHighAccuracy: true
      }
    );

    function updateUserLocation() {
      navigator.geolocation.getCurrentPosition(
        function(position) {
          const newLat = position.coords.latitude;
          const newLng = position.coords.longitude;
          
          if (userMarker) {
            userMarker.setLatLng([newLat, newLng]);
          }
          
          // Update distance display if in AR mode
          if (endPoint && document.querySelector('.ar-scene').style.display !== 'none') {
            const distance = calculateDistance(newLat, newLng, endPoint.lat, endPoint.lng);
            document.getElementById('distance').textContent = 
              `Distance to destination: ${distance.toFixed(1)} meters`;
          }
        }
      );
    }

    // Handle map clicks for destination point
    map.on('click', function(e) {
      if (!endPoint) {
        endPoint = e.latlng;
        if (markers.length > 0) {
          map.removeLayer(markers[0]);
          markers = [];
        }
        markers.push(
          L.marker(endPoint)
            .addTo(map)
            .bindPopup('Destination')
            .openPopup()
        );
        document.getElementById('startARButton').style.display = 'block';
        document.getElementById('instructions').textContent = 
          'Destination set! Click "Start AR Navigation" to begin';
      }
    });

    document.getElementById('startARButton').addEventListener('click', function() {
      document.getElementById('map').style.display = 'none';
      document.querySelector('.ar-scene').style.display = 'block';
      document.getElementById('distance').style.display = 'block';
      this.style.display = 'none';
      initAR();
    });

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // Earth's radius in meters
      const φ1 = lat1 * Math.PI/180;
      const φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2-lat1) * Math.PI/180;
      const Δλ = (lon2-lon1) * Math.PI/180;

      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c;
    }

    function calculateBearing(lat1, lon1, lat2, lon2) {
      const φ1 = lat1 * Math.PI/180;
      const φ2 = lat2 * Math.PI/180;
      const Δλ = (lon2-lon1) * Math.PI/180;

      const y = Math.sin(Δλ) * Math.cos(φ2);
      const x = Math.cos(φ1)*Math.sin(φ2) -
                Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
      const θ = Math.atan2(y, x);
      
      return (θ*180/Math.PI + 360) % 360;
    }

    function initAR() {
      if (!startPoint || !endPoint) return;

      const endEntity = document.getElementById('endPoint');
      endEntity.setAttribute('gps-entity-place', 
        `latitude: ${endPoint.lat}; longitude: ${endPoint.lng}`);

      // Create destination marker
      const endMarker = document.createElement('a-sphere');
      endMarker.setAttribute('color', 'green');
      endMarker.setAttribute('radius', '0.5');
      endEntity.appendChild(endMarker);

      // Create direction arrow
      const arrow = document.createElement('a-entity');
      arrow.setAttribute('geometry', {
        primitive: 'cone',
        height: 2,
        radiusBottom: 0.5,
        radiusTop: 0
      });
      arrow.setAttribute('material', 'color: yellow');
      arrow.setAttribute('position', '0 2 -2');
      document.querySelector('a-camera').appendChild(arrow);

      // Update arrow direction periodically
      setInterval(() => {
        navigator.geolocation.getCurrentPosition((position) => {
          const bearing = calculateBearing(
            position.coords.latitude,
            position.coords.longitude,
            endPoint.lat,
            endPoint.lng
          );
          arrow.setAttribute('rotation', `0 ${bearing} 0`);
        });
      }, 1000);
    }

    function resetPoints() {
      endPoint = null;
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
      document.getElementById('instructions').textContent = 
        'Click to set destination point';
      document.getElementById('startARButton').style.display = 'none';
      document.getElementById('map').style.display = 'block';
      document.querySelector('.ar-scene').style.display = 'none';
      document.getElementById('distance').style.display = 'none';
    }
  </script>
</body>
</html>
